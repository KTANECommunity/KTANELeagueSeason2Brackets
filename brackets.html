<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Brackets</title>

        <!-- Bootstrap and jQuery -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="css/main.css"/>
        <script src="js/common.js"></script>

        <script>
            // Navbar loading
            $(function(){
                //$("#navbar-placeholder").load("nav.html");

                //var json = $.getJSON("ktane-league.json");
                //var matches = json["matches"];

                let matches = [
                    {
                        "id": "EE1B-A",
                        "match-group": "Week 1",
                        "group": "B",
                        "category": "ExperimentalEFM",
                        "stream-url": null,
                        "date": null,
                        "status": "done",
                        "competitors": [
                            "ZekNikZ", "OdderOtter"
                        ],
                        "bombs": [
                            {
                                "bomb-info": "modsWeek1A",
                                "type": "normal",
                                "seed": 2032133,
                                "times": [
                                    {
                                        "competitor": "ZekNikZ",
                                        "time-left": 24.5,
                                        "strikes": 1,
                                        "modules": null,
                                        "log-link": null,
                                        "vod-link": null
                                    },
                                    {
                                        "competitor": "OdderOtter",
                                        "time-left": 103.233,
                                        "strikes": 2,
                                        "modules": null,
                                        "log-link": null,
                                        "vod-link": null
                                    }
                                ],
                                "winner": "ZekNikZ"
                            },
                            {
                                "bomb-info": "modsWeek1A",
                                "type": "normal",
                                "seed": 78302,
                                "times": [
                                    {
                                        "competitor": "ZekNikZ",
                                        "time-left": 30.25,
                                        "strikes": 1,
                                        "modules": null,
                                        "log-link": null,
                                        "vod-link": null
                                    },
                                    {
                                        "competitor": "OdderOtter",
                                        "time-left": 30.34,
                                        "strikes": 2,
                                        "modules": null,
                                        "log-link": null,
                                        "vod-link": null
                                    }
                                ],
                                "winner": "OdderOtter"
                            },
                            {
                                "bomb-info": "modsWeek1A",
                                "type": "normal",
                                "seed": 78302,
                                "times": [
                                    {
                                        "competitor": "ZekNikZ",
                                        "time-left": 40.28,
                                        "strikes": 1,
                                        "modules": null,
                                        "log-link": null,
                                        "vod-link": null
                                    },
                                    {
                                        "competitor": "OdderOtter",
                                        "time-left": 29.39,
                                        "strikes": 2,
                                        "modules": null,
                                        "log-link": null,
                                        "vod-link": null
                                    }
                                ],
                                "winner": "ZekNikZ"
                            }
                        ],
                        "eliminations": ["OdderOtter"],
                        "connection": null
                    },
                    {
                        "id": "EE1A-A",
                        "match-group": "Week 1",
                        "group": "A",
                        "category": "ExperimentalEFM",
                        "stream-url": "https://twitch.tv/ZekNikZOfficial",
                        "date": null,
                        "status": "inprogress",
                        "competitors": [
                            "Timwi", "samfun123"
                        ],
                        "bombs": [
                            {
                                "bomb-info": "modsWeek1A",
                                "type": "normal",
                                "seed": 2032133,
                                "times": [
                                    {
                                        "competitor": "Timwi",
                                        "time-left": 24.5,
                                        "strikes": 1,
                                        "modules": null,
                                        "log-link": null,
                                        "vod-link": null
                                    },
                                    {
                                        "competitor": "samfun123",
                                        "time-left": 13.23,
                                        "strikes": 2,
                                        "modules": null,
                                        "log-link": null,
                                        "vod-link": null
                                    }
                                ],
                                "winner": "Timwi"
                            }
                        ],
                        "winner": "Timwi",
                        "connection": null
                    },
                    {
                        "id": "EE1B-B",
                        "match-group": "Week 1",
                        "group": "B",
                        "category": "ExperimentalEFM",
                        "stream-url": "https://twitch.tv/ZekNikZOfficial",
                        "date": null,
                        "status": "notstarted",
                        "competitors": [
                            "Alice", "Bob", "Charlie", "David", "Eve"
                        ],
                        "bombs": [
                            { "winner": "Bob"},
                            { "winner": "Alice"},
                            { "winner": "David"},
                            { "winner": "Alice"},
                            { "winner": "Charlie"},
                            { "winner": "David"}
                        ],
                        "winner": ["Alice", "David"],
                        "eliminations": ["Charlie", "Eve"],
                        "connection": null
                    },
                    {
                        "id": "EE1B-B",
                        "match-group": "Week 4",
                        "group": null,
                        "category": "ExperimentalEFM",
                        "stream-url": "https://twitch.tv/ZekNikZOfficial",
                        "date": null,
                        "status": "notstarted",
                        "competitors": [
                            "Alice", "Bob", "Charlie", "David", "Eve"
                        ],
                        "bombs": [
                            { "winner": "Bob"},
                            { "winner": "Alice"},
                            { "winner": "David"},
                            { "winner": "Alice"},
                            { "winner": "Charlie"},
                            { "winner": "David"}
                        ],
                        "winner": ["Alice", "David"],
                        "eliminations": ["Charlie", "Eve"],
                        "connection": null
                    },
                    {
                        "id": "EE1B-B",
                        "match-group": null,
                        "group": null,
                        "category": "ExperimentalEFM",
                        "stream-url": "https://twitch.tv/ZekNikZOfficial",
                        "date": null,
                        "status": "notstarted",
                        "competitors": [
                            "Alice", "Bob", "Charlie", "David", "Eve"
                        ],
                        "bombs": [
                            { "winner": "Bob"},
                            { "winner": "Alice"},
                            { "winner": "David"},
                            { "winner": "Alice"},
                            { "winner": "Charlie"},
                            { "winner": "David"}
                        ],
                        "winner": ["Alice", "David"],
                        "eliminations": ["Charlie", "Eve"],
                        "connection": null
                    },
                    {
                        "id": "EE1B-B",
                        "match-group": "Week 4",
                        "group": "A",
                        "category": "ExperimentalEFM",
                        "stream-url": "https://twitch.tv/ZekNikZOfficial",
                        "date": null,
                        "status": "notstarted",
                        "competitors": [
                            "Alice", "Bob", "Charlie", "David", "Eve"
                        ],
                        "bombs": [
                            { "winner": "Bob"},
                            { "winner": "Alice"},
                            { "winner": "David"},
                            { "winner": "Alice"},
                            { "winner": "Charlie"},
                            { "winner": "David"}
                        ],
                        "winner": ["Alice", "David"],
                        "eliminations": ["Charlie", "Eve"],
                        "connection": null
                    },
                    {
                        "id": "EE1B-B",
                        "match-group": "Week 4",
                        "group": "A",
                        "category": "VanillaTeam",
                        "stream-url": "https://twitch.tv/ZekNikZOfficial",
                        "date": null,
                        "status": "notstarted",
                        "competitors": [
                            "Alice", "Bob", "Charlie", "David", "Eve"
                        ],
                        "bombs": [
                            { "winner": "Bob"},
                            { "winner": "Alice"},
                            { "winner": "David"},
                            { "winner": "Alice"},
                            { "winner": "Charlie"},
                            { "winner": "David"}
                        ],
                        "winner": ["Alice", "David"],
                        "eliminations": ["Charlie", "Eve"],
                        "connection": null
                    }
                ];       
                
                makeBrackets(matches);
            });

            function makeBrackets(matches) {
                let matchList = {};
                for (let match of matches) {
                    let category = match["category"];
                    if (category === null || category === undefined) {
                        continue;
                    }
                    if (!(category in matchList)) {
                        matchList[category] = [];
                    }
                    matchList[category].push(match);
                }
                for (let category in matchList) {
                    $("#brackets").append($("<h1>", {"id": category}).text(category));
                    $("#brackets").append(makeBracket(matchList[category]));
                }
            }

            function makeBracket(matches) {
                var bracket = {"none": {"none": []}};
                for (var match of matches) {
                    let matchGroup = match["match-group"];
                    let group = match["group"];
                    if (matchGroup !== undefined && matchGroup !== null) {
                        if (!(matchGroup in bracket)) {
                            bracket[matchGroup] = {"none": []};
                        }
                        if (group !== undefined && group !== null) {
                            if (!(group in bracket[matchGroup])) {
                                bracket[matchGroup][group] = [];
                            }
                        }
                    } else {
                        if (group !== undefined && group !== null) {
                            if (!(group in bracket["none"])) {
                                bracket["none"][group] = [];
                            }
                        }
                    }
                }

                for (var match of matches.sort((a, b) => a.id > b.id)) {
                    let matchGroup = match["match-group"];
                    if (!(matchGroup !== undefined && matchGroup !== null)) {
                        matchGroup = "none";
                    }
                    let group = match["group"];
                    if (!(group !== undefined && group !== null)) {
                        group = "none";
                    }
                    bracket[matchGroup][group].push(makeMatchCard(match, false));
                }

                for (let matchGroupName in bracket) {
                    if (bracket[matchGroupName]["none"] !== undefined && bracket[matchGroupName]["none"].length === 0) {
                        delete bracket[matchGroupName]["none"];
                    }
                }
                if (Object.keys(bracket["none"]).length === 0) {
                    delete bracket["none"];
                }

                var result = $("<div>", {"class": "bracket"});
                for (var matchGroup of Object.keys(bracket).sort()) {
                    let name = matchGroup;
                    if (matchGroup === "none" || matchGroup === null || matchGroup === undefined) {
                        name = "Unsorted";
                    }
                    let deck;
                    if (Object.keys(bracket[matchGroup]).length > 1 || Object.keys(bracket[matchGroup]) != "none") {
                        deck = $("<div>", {"class": "bracket-week bracket-week-groups"});
                        deck.append($("<h3>", {"class": "match-group-title"}).text(name));
                        for (let group of Object.keys(bracket[matchGroup]).sort()) {
                            let groupName = group;
                            if (group === "none" || group === null || group === undefined) {
                                groupName = "No Group";
                            } else {
                                groupName = "Group " + groupName;
                            }
                            let cardGroup = $("<aside>", {"class": "group-col bracket-group card-deck"});
                            cardGroup.append($("<div>", {"class": "group-title"}).append($("<h6>").text(`${groupName}`)));
                            for (let card of bracket[matchGroup][group]) {
                                cardGroup.append(card);
                            }
                            deck.append(cardGroup);
                        }
                    } else {
                        deck = $("<div>", {"class": "group-col bracket-week"});
                        deck.append($("<h3>", {"class": "match-group-title"}).text(name));
                        for (let card of bracket[matchGroup][Object.keys(bracket[matchGroup])[0]]) {
                            deck.append(card);
                        }
                    }
                    result.append(deck);
                }
                return result;
            }
        </script>
    </head>
    <body data-spy="scroll" data-target=".icon-bar" data-offset="50">
        <!-- Import Navbar -->
        <!--<div id="navbar-placeholder" class="container">-->
                <nav class="navbar navbar-expand-md bg-dark fixed-top navbar-dark ">
                        <a class="navbar-brand" href="#">KTANE League Season 2</a>
                        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                        <div class="collapse navbar-collapse" id="collapsibleNavbar">
                            <ul class="navbar-nav">
                                <li class="nav-item">
                                    <a class="nav-link" href="#">Information</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#">Brackets</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#">Standings</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#">Players</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#">Teams</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#">Matches</a>
                                </li>
                            </ul>
                        </div>
                    </nav>
        <!--</div>-->

        

        <div class="icon-bar">
            <a href="#VanillaTeam">VT</a>
            <a href="#vanilla-team">MI</a>
            <a href="#vanilla-team">MT</a>
            <a href="#vanilla-team">EI</a>
            <a href="#ExperimentalEFM">ET</a>
        </div>

        <div id="brackets"></div>
    </body>
</html>